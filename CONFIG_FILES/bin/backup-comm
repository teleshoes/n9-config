#!/usr/bin/perl
use strict;
use warnings;

my $type = shift() || '';
die "Usage: $0 [sms|call]\n" if $type !~ /^(sms|call)$/;

my $dest = "/home/user/MyDocs/backup-$type";
my $exec = "${type}backuprestore";

my $grepCmd;

my $gnuGrep = "/opt/gnu-utils/bin/grep";
if(-x $gnuGrep){
  $grepCmd = "$gnuGrep --line-buffered";
}else{
  $grepCmd = "grep";
}

sub run(@){
  print "@_\n";
  system @_;
}

run "mkdir -p $dest";
my $name = `date +%Y_%m_%d-%s`;
chomp $name;

my $cmd = ''
  . " $exec export $dest/$name.$type"
  . " 2>&1"
  . " | $grepCmd -v \"Not cleaning up obsolete resources for nao:hasTag\"";

run "su user -c 'source /etc/profile; $cmd'";

run "chown", "user.users", "-R", $dest;

my @lines = `cat $dest/$name.$type`;
print "exported " . @lines . " items\n";
