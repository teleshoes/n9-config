#!/usr/bin/perl
use strict;
use warnings;

sub backup($;$);

my $dir = "$ENV{HOME}/Code/n9";

my $host = `n9`;
chomp $host;

sub main(@){
  print "getting sudo pw cached\n";
  system "sudo", "echo", "ok";
  die "failed" if $? != 0;

  print "making sure n9 is ssh-able\n";
  system "n9", "-s", "echo found n9!\n";
  die "failed" if $? != 0;

  backup "dcim-backup";
  backup "sync-pixmirror";

  backup "sync-pidgin";
  backup "sync-mydocs";
  backup "sync-fbreader backup";
  backup "sync-qtodo";
  backup "fetch-contacts";
  backup "fetch-sms", 2;
}

sub backup($;$){
  my ($backupScript, $retries) = @_;
  $retries = 0 if not defined $retries;

  print "\n\n\n=========$backupScript\n";
  system "$dir/$backupScript";

  if($? != 0){
    if($retries > 0){
      print "\n\n\n!!! $backupScript failed, RETRYING $retries more time(s)\n";
      backup $backupScript, $retries-1;
    }else{
      die "$backupScript failed";
    }
  }
}

&main(@ARGV);
